#!/bin/bash

GIT_SHA_FILE=${HOME}/build-git-sha

# move the application source
mv /tmp/src $HOME/src

# restore build artifacts
if [[ -d /tmp/artifacts/ ]]; then
    echo "Restoring build artifacts"
    mv /tmp/artifacts/* $HOME/.
    mv $HOME/node_modules $HOME/src/node_modules
    mv $HOME/modules $HOME/src/resources/modules
fi

pushd ${HOME}/src
# build application artifacts
echo $(< ${GIT_SHA_FILE}) 
echo $(git rev-parse --short HEAD)
if [[ ! -f GIT_SHA_FILE || $(< ${GIT_SHA_FILE}) != $(git rev-parse --short HEAD) ]]; then
    # move the previous node modules
    ./bin/build
    mv ${HOME}/src/target/uberjar/metabase.jar $HOME
    git rev-parse --short HEAD > ${GIT_SHA_FILE}
    mv node_modules $HOME
    mv resources/modules $HOME
fi
popd

